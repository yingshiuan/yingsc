---
import NavBar from '@/components/layout/NavBar.astro';
import '@/styles/global.css';

const { siteTitle = 'Yinz' } = Astro.props;

const baseUrl = import.meta.env.BASE_URL;

---

<script>
  type Mode = 'light_mode' | 'dark_mode' | 'tonality';

  const modeIcons: Record<Mode, string> = {
    tonality: 'tonality',
    light_mode: 'light_mode',
    dark_mode: 'dark_mode',
  };

  function getUserPreference(): Mode {
    return (localStorage.getItem('mode') as Mode) || 'tonality';
  }

  function saveUserPreference(userPreference: Mode): void {
    localStorage.setItem('mode', userPreference);
  }

  function getAppliedMode(userPreference: Mode): 'light_mode' | 'dark_mode' {
    if (userPreference === 'light_mode') return 'light_mode';
    if (userPreference === 'dark_mode') return 'dark_mode';

    // If "tonality" → follow system preference
    return matchMedia('(prefers-color-scheme: dark)').matches
      ? 'dark_mode'
      : 'light_mode';
  }

  function rotatePreferences(userPreference: Mode): Mode {
    switch (userPreference) {
      case 'tonality':
        return 'light_mode';
      case 'light_mode':
        return 'dark_mode';
      case 'dark_mode':
        return 'tonality';
      default:
        return 'tonality';
    }
  }

  function setAppliedMode(mode: Mode): void {
    if (mode === 'tonality') {
      // Apply your special tonality class
      document.body.className = 'tonality';
    } else {
      // Apply normal light/dark
      document.body.className = mode;
    }

    // Update <meta name="color-scheme">
    const colorScheme = document.querySelector<HTMLMetaElement>(
      'meta[name="color-scheme"]'
    );
    if (colorScheme) {
      if (mode === 'tonality') {
        colorScheme.content = 'light dark'; // allow both, so system decides
      } else {
        colorScheme.content = mode.replace('_mode', '');
      }
    }
  }

  function initScrollBar() {
    let prevScrollPos = window.pageYOffset;
    const scrollBar = document.getElementById('scroll');
    if (!scrollBar) return;

    window.addEventListener('scroll', () => {
      const currentScrollPos = window.pageYOffset;

      if (prevScrollPos > currentScrollPos) {
        scrollBar.style.top = '2rem'; // scrolling up → show
      } else {
        scrollBar.style.top = '-7rem'; // scrolling down → hide
      }

      prevScrollPos = currentScrollPos;
    });
  }

  function init(): void {
    let userPreference: Mode = getUserPreference();

    const themeDisplay = document.getElementById('mode') as HTMLElement | null;
    const themeTooltip = document.getElementById(
      'mode-tooltip'
    ) as HTMLElement | null;
    const themeToggler = document.getElementById(
      'mode-button'
    ) as HTMLButtonElement | null;

    if (themeToggler && themeDisplay) {
      themeToggler.onclick = () => {
        userPreference = rotatePreferences(userPreference);
        saveUserPreference(userPreference);

        const appliedMode = getAppliedMode(userPreference);

        // Update icon (use stored preference, not applied mode)
        themeDisplay.innerText = modeIcons[userPreference];

        // Update tooltip (use applied mode so system preference is reflected)
        if (themeTooltip) {
          themeTooltip.innerText = appliedMode.replace('_', ' ');
        }

        setAppliedMode(appliedMode);
      };
    }

    // Initial apply
    const appliedMode = getAppliedMode(userPreference);
    setAppliedMode(appliedMode);

    if (themeDisplay) themeDisplay.innerText = modeIcons[userPreference];
    if (themeTooltip) themeTooltip.innerText = appliedMode.replace('_', ' ');
  }

  document.addEventListener('readystatechange', () => {
    if (document.readyState === 'complete') {
      init();
    }
  });

  window.addEventListener('DOMContentLoaded', initScrollBar);
</script>

<header>
  <div class="header-container">
    <div class="flex flex-col">
      <div class="items-center sticky">
        <div class="logo">
          <!-- Replace with your logo or <img> if needed -->
        </div>

        <div class="theme-bar">
          <div class="flex relative group items-center py-[0.5rem]">
              <a href=`${baseUrl}` class="theme-link">
                {siteTitle}
              </a>
              <span class="tooltip">"Nice to meet you!"</span>
          </div>
          <NavBar baseUrl={baseUrl}/>
          <div class="relative items-center group">
            <button
              id="mode-button"
              class="mode-button"
              aria-label="Toggle theme">
              <span class="material-symbols-outlined" id="mode">tonality</span>
            </button>
            <span class="tooltip" id="mode-tooltip">mode</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</header>

<div id="scroll" class="scroll-bar">
  <p>
    Recently completed a Research Internship at DisneyResearch|Studios, seeking
    my next challenge in <b>creative technology</b> and
    <b>software development!</b>
  </p>
</div>

<style>
  @reference "@/styles/global.css";

  .header-container {
    @apply top-0 left-0 right-0 fixed z-[100] bg-[#2C2C2C] opacity-90;
  }

  .theme-bar {
    @apply flex justify-between items-center py-0 px-[5rem];
  }

  .theme-link {
    @apply text-white hover:text-[var(--color-text-hover)] hover:text-shadow-[0.05rem_0.05rem_var(--color-text-primary)];
  }


  .mode-button {
    @apply text-white bg-transparent border-0 cursor-pointer text-[1.5rem] relative hover:text-[var(--color-text-secondary)] items-center;
  }

  .scroll-bar {
    @apply block text-center mt-[1.5rem] py-[0.5rem] bg-[var(--color-caption-primary)] text-[var(--color-caption-secondary)];
  }

  .scroll-bar p {
    @apply m-0;
  }
  .tooltip {
    @apply invisible absolute text-white w-max bottom-[-3rem] -translate-x-1/3 bg-[#2C2C2C] p-[0.2rem] z-10 rounded-sm group-hover:visible;
  }

  /* Arrow */
  .tooltip::after {
    content: '';
    position: absolute;
    bottom: 100%;
    left: 30%;
    margin-left: -0.5rem;
    border-width: 0.5rem;
    border-style: solid;
    border-color: transparent transparent #2c2c2c transparent; /* Arrow */
  }

  @media all and (max-width: 900px) {
    .header-container {
      background: none;
      width: 90%;
    }

    .theme-bar {
      @apply px-[2rem] py-[0.5rem];
    }

    .infoBar {
      position: fixed;
      margin: 1rem auto 0rem auto;
      padding-top: 0.2rem;
    }
  }
</style>
